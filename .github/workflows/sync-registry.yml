name: Sync Registry Docs

on:
  # Allow manual trigger
  workflow_dispatch:

  # Run hourly to pick up registry changes
  schedule:
    - cron: "15 * * * *" # Every hour at :15

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    name: Sync Registry Documentation
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Set up Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v5
        with:
          python-version: "3.11"

      - name: Set up Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: latest
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Generate registry docs
        run: python scripts/generate_registry_docs.py

      - name: Format generated files
        run: npx prettier --write docs/registry/

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet docs/registry/index.mdx; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        id: cpr
        if: steps.changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@c5a7806660adbe173f04e3e038b0ccdcd758773c # v6
        with:
          commit-message: "docs: update registry agents"
          title: "docs: update registry agents"
          body: |
            This PR updates the registry documentation with the latest agents from the ACP Registry CDN.

            Auto-generated by the sync-registry workflow.
          branch: auto/sync-registry
          delete-branch: true
          labels: documentation

      - name: Enable auto-merge
        if: steps.cpr.outputs.pull-request-number
        run: gh pr merge --squash --auto "${{ steps.cpr.outputs.pull-request-number }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
